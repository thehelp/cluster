<!DOCTYPE html><html lang="en"><head><title>src/server/graceful</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/server/graceful"><meta name="groc-project-path" content="src/server/graceful.js"><meta name="groc-github-url" content="https://github.com/thehelp/cluster"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/thehelp/cluster/blob/master/src/server/graceful.js">src/server/graceful.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="graceful">Graceful</h1>

<p>Encapsulates everything needed to shut down a worker process without interrupting
anything important, even active requests on an http server.</p>

<p>There are three major ways to interact with an instance of this class:</p>

<ol>
<li>Kick off shutdown by calling <code>shutdown()</code> with or without the error object that
initiated the shutdown.</li>
<li>Register for notification on shutdown with <code>on('shutdown', fn)</code>. This is a good time
to close all open resources, do last bits of work.</li>
<li>Register a 'check' function with <code>addCheck(fn)</code> to delay shutdown if shutdown work
is still happening. Return true if we're okay to stop the process, false if work is still
going on. By default you only have five seconds before the process will be terminated even
if you're not ready.</li>
</ol></div></div><div class="code"><div class="wrapper"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">core</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;thehelp-core&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logShim</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;thehelp-log-shim&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">localUtil</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./util&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>constructor</code> has no required parameters. Optional parameters:</p>

<ul>
<li><code>pollInterval</code> - how often to attempt to take down process by first checking all
registered 'ready to stop process' check functions</li>
<li><code>timeout</code> - how long to wait for the 'ready to stop process' checks before taking the
process down forcefully</li>
<li><code>messenger</code> - a <code>function(err, options, cb)</code> that gets the information supplied to the
<code>shutdown()</code> method. Defaults to <code>thehelp-last-ditch</code>.</li>
<li><code>log</code> - a logger object: <code>info</code>, <code>warn</code> and <code>error</code> keys with the signature
<code>function(string)</code>. By default, whatever <code>thehelp-log-shim</code> gives us.</li>
</ul>

<p><em>Note: it's recommended to create an instance of this class just once per process, since
it listens for a number of process-level events. See <code>_setupListeners()</code> below.</em></p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Graceful</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*jshint maxcomplexity: 9 */</span>

  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">shuttingDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_checks</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_sending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pollInterval</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pollInterval</span> <span class="o">||</span> <span class="mi">250</span><span class="p">;</span>
  <span class="nx">localUtil</span><span class="p">.</span><span class="nx">verifyType</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;pollInterval&#39;</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">||</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="nx">localUtil</span><span class="p">.</span><span class="nx">verifyType</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">messenger</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">messenger</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;thehelp-last-ditch&#39;</span><span class="p">);</span>
  <span class="nx">localUtil</span><span class="p">.</span><span class="nx">verifyType</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;messenger&#39;</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">log</span> <span class="o">||</span> <span class="nx">logShim</span><span class="p">(</span><span class="s1">&#39;thehelp-cluster:graceful&#39;</span><span class="p">);</span>
  <span class="nx">localUtil</span><span class="p">.</span><span class="nx">verifyLog</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">addCheck</span><span class="p">(</span><span class="kd">function</span> <span class="nx">areWeSending</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">_sending</span> <span class="o">===</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_process</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_process</span> <span class="o">||</span> <span class="nx">process</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cluster</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_cluster</span> <span class="o">||</span> <span class="nx">cluster</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">=</span> <span class="nx">localUtil</span><span class="p">.</span><span class="nx">getLogPrefix</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_setupListeners</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Graceful</span><span class="p">.</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;More than one Graceful instance created in this process. &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;There are now duplicate process-level wireups!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">Graceful</span><span class="p">.</span><span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Graceful</span><span class="p">,</span> <span class="nx">EventEmitter</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Graceful</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="public-methods">Public methods</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A quick helper function, since other classes use <code>Graceful.instance</code> to find their
reference to your created <code>Graceful</code> object; you don't have to keep the instance
around. Only creates a new instance if no previous instance has been created in this
process.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Graceful</span><span class="p">.</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Graceful</span><span class="p">.</span><span class="nx">instance</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Graceful</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>shutdown</code> is the key method for interacting with this class. When something goes
wrong, call this method with the error and any additional information (like the <code>url</code>
being serviced). The http server will be stopped, the error will be saved/sent via
<code>this.messenger</code> and we'll start the process of checking to see if we can take down the
process via <code>this._exit()</code>.</p>

<p><em>Note: to be notified when this method is called, register for the 'shutdown' event
(<code>Graceful</code> is an <code>EventEmitter</code>):</em></p>

<pre><code>graceful.on('shutdown', function() {
  // do stuff to prepare for shutdown
})
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">shutdown</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">shuttingDown</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">shuttingDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">+</span> <span class="s1">&#39; gracefully shutting down!&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sendError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">info</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Graceful: shutdown event handler threw: &#39;</span> <span class="o">+</span>
        <span class="nx">core</span><span class="p">.</span><span class="nx">breadcrumbs</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_exit</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>addCheck</code> allows you to provide a callback you can use to delay <code>process.exit()</code> until
you are finished doing something. Return something truthy to signal your readiness for
<code>process.exit()</code>.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addCheck</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">addCheck</span><span class="p">(</span><span class="nx">check</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">check</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">check</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;need to provide a function!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_checks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">check</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="helper-methods">Helper methods</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_sendError</code> uses <code>this.messenger</code> to save/send the error provided to <code>shutdown()</code>. It
it sets <code>this._sending = true</code> so we won't take the process down before the call is
complete.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_sendError</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_sendError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_sending</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">messenger</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">_sending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_check</code> returns true if all registered check methods returned true.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_check</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_check</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_checks</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_checks</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">max</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_checks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_checks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">check</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Graceful: check function threw: &#39;</span> <span class="o">+</span> <span class="nx">core</span><span class="p">.</span><span class="nx">breadcrumbs</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_exit</code> _exits if <code>check()</code> returns true. Otherwise it sets an interval to continue
trying. It also sets a timer - if we never get a successful <code>check()</code> call, we
take down the process anyway.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_exit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_exit</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">+</span> <span class="s1">&#39; calling all provided pre-exit check functions...&#39;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_check</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_clearTimers</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_finalLog</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">+</span> <span class="s1">&#39; passed all checks! Shutting down!&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="nx">tryAgain</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">_exit</span><span class="p">();</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">pollInterval</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">forceKill</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">_clearTimers</span><span class="p">();</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">_finalLog</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">+</span> <span class="s1">&#39; checks took too long. &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Killing process now!&#39;</span><span class="p">);</span>

    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_clearTimers</code> properly gets rid of the timers created in <code>_exit()</code></p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_clearTimers</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_clearTimers</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">interval</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">interval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_finalLog</code> makes a final log entry then takes down the process when that log call is
complete.</p>

<p><em>Why so complex? To ensure that any <code>winston</code> file transports are properly flushed. You'll
note without this, if <code>_die()</code> is called directly in <code>_exit()</code> above, the main integration
tests will result in log files without the final 'about to exit with code X' entries.</em></p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finalLog</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_finalLog</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">die</span> <span class="o">=</span> <span class="nx">localUtil</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">_die</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">type</span><span class="p">](</span><span class="nx">message</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*jshint unused: false */</span>
    <span class="nx">die</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">die</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_die</code> calls <code>process._exit()</code> with the right error code based on <code>this.error</code> (set in
<code>shutdown()</code>).</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_die</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_die</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">exitCode</span> <span class="o">||</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_setupListeners</code> sets up some event wireups. We start the shutdown process when the
process gets a 'SIGTERM' signal, or when the master worker disconnects. And we log
on process exit.</p></div></div><div class="code"><div class="wrapper"><span class="nx">Graceful</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setupListeners</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_setupListeners</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cluster</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">process</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_process</span><span class="p">;</span>

  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SIGTERM&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">gracefulShutdown</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_this</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">_logPrefix</span> <span class="o">+</span> <span class="s1">&#39; about to exit with code &#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">worker</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cluster</span><span class="p">.</span><span class="nx">worker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">gracefulShutdown</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div></div></body></html>